resource "google_compute_instance_template" "gcve_mon" {
  project     = var.project_id
  name        = "gcve-mon"
  description = "This template is used to create GCVE Monitoring Agent instances."

  tags = var.network_tag

  instance_description = "gcve monitoring agent instance"
  machine_type         = "e2-standard-2"
  can_ip_forward       = false

  scheduling {
    automatic_restart   = true
    on_host_maintenance = "MIGRATE"
  }

  disk {
    source_image      = "debian-cloud/debian-10"
    auto_delete       = true
    boot              = true
  }

  network_interface {
    network            = var.network
    subnetwork         = var.subnetwork
    subnetwork_project = var.subnetwork_project
  }

  metadata = {
    startup-script = local.startup_script
  }

  service_account {
    email  = google_service_account.gcve_mon_sa.email
    scopes = ["cloud-platform"]
  }
  depends_on = [google_service_account.gcve_mon_sa]
}